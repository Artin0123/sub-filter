# sub-filter

Cloudflare Workers è¨‚é–±åˆä½µèˆ‡åˆ†å¡Šæœå‹™ã€‚æ•´åˆå¤šå€‹ä¾†æºè¨‚é–±ï¼ˆvmess/vless/trojan/ssï¼‰ï¼Œè‡ªå‹•å»é‡ä¸¦ç”¢ç”Ÿåˆ†å¡Šè¼¸å‡ºï¼Œæ”¯æ´ ETag/304 èˆ‡é‚Šç·£å¿«å–ã€‚

## æ ¸å¿ƒåŠŸèƒ½

- **åˆ†å¡Šè¼¸å‡º**ï¼š`/sub_1`ã€`/sub_2`â€¦ï¼ˆæ¯å¡Šé è¨­ 400 ç­†ï¼Œå¯èª¿æ•´ï¼‰
- **Base64 ç·¨ç¢¼**ï¼šå¯é¸æ“‡å°‡è¨‚é–±å…§å®¹ Base64 ç·¨ç¢¼ï¼ˆæ¨™æº–è¨‚é–±æ ¼å¼ï¼‰
- **ä¾†æºç®¡ç†**ï¼šWeb ç®¡ç†é¢æ¿ï¼Œå¯æ–°å¢/ç§»é™¤ä¾†æºèˆ‡èª¿æ•´åˆ†å¡Šå¤§å°
- **è‡ªå‹•æ›´æ–°**ï¼š`POST /refresh` è§¸ç™¼æŠ“å– â†’ è§£æ â†’ å»é‡ â†’ å¯«å…¥ KV
- **æ™ºèƒ½å¿«å–**ï¼šETag/304 æ”¯æ´èˆ‡ 5 åˆ†é˜é‚Šç·£å¿«å–ï¼Œè‡ªå‹•æª¢æ¸¬å…§å®¹è®Šæ›´
- **Token ä¿è­·**ï¼šè¨‚é–±ç«¯é»éœ€æä¾›æœ‰æ•ˆ tokenï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
- **CI æ•´åˆ**ï¼šGitHub Actions å®šæ™‚æ›´æ–°

## å¿«é€Ÿé–‹å§‹

### 1. ç’°å¢ƒè®Šæ•¸è¨­å®š

**å¿…è¦è®Šæ•¸**ï¼š
- `ADMIN_PASSWORD` - ç®¡ç†ä»‹é¢ç™»å…¥å¯†ç¢¼ï¼ˆä¹Ÿç”¨æ–¼ç”Ÿæˆè¨‚é–± tokenï¼‰

**æœ¬åœ°é–‹ç™¼**ï¼š
```bash
echo "ADMIN_PASSWORD=your_password_here" > .dev.vars
```

**ç”Ÿç”¢ç’°å¢ƒ**ï¼ˆCloudflare Workersï¼‰ï¼š
```bash
wrangler secret put ADMIN_PASSWORD
# è¼¸å…¥ä½ çš„å¯†ç¢¼
```

### 2. KV Namespace è¨­å®š

**å»ºç«‹ KV**ï¼š
```bash
# å»ºç«‹ KV namespace
wrangler kv namespace create KV_NAMESPACE

# æœƒå¾—åˆ°é¡ä¼¼è¼¸å‡ºï¼š
# { binding = "KV_NAMESPACE", id = "abc123..." }
```

**æ›´æ–° `wrangler.jsonc`**ï¼š
```jsonc
{
  "kv_namespaces": [
    {
      "binding": "KV_NAMESPACE",  // âš ï¸ å¿…é ˆæ˜¯ "KV_NAMESPACE"ï¼ˆç¨‹å¼ç¢¼ä¸­ä½¿ç”¨ï¼‰
      "id": "ä½ çš„KV_ID"            // æ›¿æ›æˆä¸Šé¢å»ºç«‹çš„ ID
    }
  ]
}
```

**é‡è¦**ï¼š
- âœ… `binding` å¿…é ˆæ˜¯ `"KV_NAMESPACE"`ï¼ˆç¨‹å¼ç¢¼ä¸­å›ºå®šä½¿ç”¨æ­¤åç¨±ï¼‰
- âœ… `id` æ›¿æ›æˆä½ çš„ KV namespace ID
- âš ï¸ æœ¬åœ°é–‹ç™¼æ™‚ Miniflare æœƒè‡ªå‹•æ¨¡æ“¬ KVï¼Œä¸éœ€è¦çœŸå¯¦ ID

### 3. éƒ¨ç½²

```bash
npm install
npm run deploy
```

### 4. GitHub Actions è‡ªå‹•æ›´æ–°ï¼ˆå¯é¸ï¼‰

å¦‚æœè¦ä½¿ç”¨ GitHub Actions å®šæ™‚æ›´æ–°è¨‚é–±ï¼Œéœ€è¦è¨­å®šä»¥ä¸‹ Secretsï¼š

**åœ¨ GitHub repo è¨­å®š Secrets**ï¼ˆSettings â†’ Secrets and variables â†’ Actionsï¼‰ï¼š

| Secret åç¨±      | èªªæ˜                           | ç¯„ä¾‹                                               |
| ---------------- | ------------------------------ | -------------------------------------------------- |
| `REFRESH_URL`    | ä½ çš„ Worker çš„ `/refresh` ç«¯é» | `https://sub-filter.your-name.workers.dev/refresh` |
| `ADMIN_PASSWORD` | èˆ‡ Worker ç›¸åŒçš„ç®¡ç†å¯†ç¢¼       | `your_password_here`                               |

**æ³¨æ„**ï¼š
- âœ… GitHub Actions ä½¿ç”¨ HMAC ç°½åçš„ Bearer tokenï¼ˆå®‰å…¨ï¼‰
- â° é è¨­æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼ˆå¯åœ¨ `.github/workflows/refresh.yml` ä¿®æ”¹ cronï¼‰
- ğŸ“Š åŸ·è¡Œçµæœæœƒé¡¯ç¤ºæ›´æ–°çµ±è¨ˆï¼ˆrecordsã€chunks ç­‰ï¼‰

**æ‰‹å‹•è§¸ç™¼**ï¼š
- é€²å…¥ GitHub repo â†’ Actions â†’ Refresh Subscription â†’ Run workflow

**Cron æ™‚é–“èªªæ˜**ï¼š
```yaml
# æ¯å°æ™‚åŸ·è¡Œï¼ˆé è¨­ï¼‰
- cron: "0 * * * *"

# æ¯ 6 å°æ™‚åŸ·è¡Œ
- cron: "0 */6 * * *"

# æ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œ
- cron: "0 2 * * *"
```

## æ¶æ§‹

**å¹³å°**ï¼šCloudflare Workers + Workers KV

**ä¸»è¦æ¨¡çµ„**ï¼ˆ`src/`ï¼‰ï¼š
- `index.ts` - è·¯ç”±èˆ‡ç®¡ç†é¢æ¿
- `update.ts` - æ›´æ–°ç®¡ç·šï¼ˆæŠ“å–/è§£æ/å»é‡/åˆ†å¡Šï¼‰
- `subscription.ts` - å”è­°è§£æèˆ‡ç·¨ç¢¼ï¼ˆvmess/vless/trojan/ssï¼‰
- `dedup.ts` - å»é‡é‚è¼¯ï¼ˆ`server:port:servername:credential`ï¼‰
- `fetchers.ts` - ä½µç™¼æŠ“å–èˆ‡é‡è©¦
- `auth.ts` - HMAC Cookie èˆ‡ Bearer é©—è­‰
- `cache.ts` - é‚Šç·£å¿«å–å°è£
- `hash.ts` - SHA-256 ETag ç”Ÿæˆ
- `kv.ts` - KV key å¸¸æ•¸

## API ç«¯é»

**è¨‚é–±ç«¯é»**ï¼ˆéœ€ tokenï¼‰ï¼š
- `GET /sub_{i}?token=xxx` - ç¬¬ i å¡Šå…§å®¹ï¼ˆ1 èµ·ç®—ï¼Œä¾‹å¦‚ `/sub_1?token=xxx`ï¼‰

**ç®¡ç†ç«¯é»**ï¼ˆéœ€ç™»å…¥ï¼‰ï¼š
- `GET /` - ç®¡ç†é¢æ¿
- `POST /login` / `POST /logout` - ç™»å…¥/ç™»å‡º
- `GET /list` - åˆ—å‡ºä¾†æº
- `POST /add` / `POST /remove` - æ–°å¢/ç§»é™¤ä¾†æº
- `GET /config` / `POST /config` - è®€å–/è¨­å®šé…ç½®ï¼ˆ`chunk_size`ã€`base64_encode`ï¼‰

**æ›´æ–°ç«¯é»**ï¼ˆéœ€ç™»å…¥æˆ– Bearerï¼‰ï¼š
- `POST /refresh` - ç«‹å³æ›´æ–°è¨‚é–±

## å»é‡é‚è¼¯

æœ¬å°ˆæ¡ˆçš„å»é‡ç­–ç•¥åƒè€ƒä¸¦æ”¹é€²è‡ª [subs-check](https://github.com/beck-8/subs-check) çš„å¯¦ä½œï¼š

**å»é‡éµ**ï¼š`server:port:servername:credential`

**æ”¹é€²é»**ï¼š
- âœ… **Server æ­£è¦åŒ–**ï¼šå°‡ server è½‰ç‚ºå°å¯«ï¼Œé¿å… `Example.COM` å’Œ `example.com` è¢«è¦–ç‚ºä¸åŒç¯€é»
- âœ… **Port é©—è­‰**ï¼šéæ¿¾ port = 0 æˆ–ç„¡æ•ˆçš„ç¯€é»
- âœ… **SNI Fallback**ï¼šæ”¯æ´ `servername` æˆ– `sni` æ¬„ä½ï¼Œæå‡ç›¸å®¹æ€§
- âœ… **å‹åˆ¥å®‰å…¨**ï¼šä½¿ç”¨ TypeScript å¼·å‹åˆ¥ï¼Œæ¸›å°‘åŸ·è¡Œæ™‚éŒ¯èª¤

**ç¯„ä¾‹**ï¼š
```typescript
// é€™å…©å€‹ç¯€é»æœƒè¢«è¦–ç‚ºé‡è¤‡ï¼ˆç›¸åŒé€£ç·šåƒæ•¸ï¼‰
vless://uuid123@example.com:443?sni=cdn.example.com#ç¯€é»A
vless://uuid123@EXAMPLE.COM:443?sni=cdn.example.com#ç¯€é»B  // è¢«éæ¿¾

// é€™å…©å€‹ç¯€é»ä¸æœƒè¢«è¦–ç‚ºé‡è¤‡ï¼ˆä¸åŒ serverï¼‰
vless://uuid123@server1.com:443#é¦™æ¸¯ç¯€é»
vless://uuid123@server2.com:443#é¦™æ¸¯ç¯€é»  // ä¿ç•™
```

## ä¾†æºé¡å‹

é™¤äº†æ¨™æº–çš„ HTTP(S) è¨‚é–± URLï¼Œæœ¬å°ˆæ¡ˆé‚„æ”¯æ´ä»¥ä¸‹ç‰¹æ®Šæ ¼å¼ï¼Œæ–¹ä¾¿æ¸¬è©¦å’Œèª¿è©¦ï¼š

### 1. HTTP(S) URL - æ¨™æº–è¨‚é–±é€£çµ

**ç”¨é€”**ï¼šå¾å¤–éƒ¨ä¼ºæœå™¨æŠ“å–è¨‚é–±å…§å®¹

**æ ¼å¼**ï¼šä»»æ„ HTTP(S) URL

**ç¯„ä¾‹**ï¼š
```
https://example.com/subscription
https://example.com/sub
https://example.com/api/nodes
https://example.com/v2ray
https://example.com/123
https://example.com/abc.json
```

**æ”¯æ´çš„å…§å®¹æ ¼å¼**ï¼š
- âœ… ç´”æ–‡å­—ç¯€é»åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€å€‹ URIï¼‰
- âœ… Base64 ç·¨ç¢¼çš„è¨‚é–±ï¼ˆè‡ªå‹•åµæ¸¬ä¸¦è§£ç¢¼ï¼‰
- âœ… æ··åˆæ ¼å¼ï¼ˆéƒ¨åˆ† Base64ï¼Œéƒ¨åˆ†ç´”æ–‡å­—ï¼‰

**Base64 è‡ªå‹•è™•ç†**ï¼ˆé‡å°ä¾†æº URL è¿”å›çš„å…§å®¹ï¼‰ï¼š

ç³»çµ±æœƒæ™ºèƒ½åˆ¤æ–·ä¾†æºå…§å®¹æ˜¯å¦ç‚º Base64 ç·¨ç¢¼ï¼š

1. **å·²åŒ…å«å”è­°çš„ç´”æ–‡å­—**ï¼ˆå¦‚ `vless://...`ï¼‰
   - ç›´æ¥ä½¿ç”¨ï¼Œä¸å˜—è©¦è§£ç¢¼ âœ…

2. **Base64 ç·¨ç¢¼çš„è¨‚é–±**
   - å˜—è©¦è§£ç¢¼
   - æª¢æŸ¥æ˜¯å¦åŒ…å«ä»£ç†å”è­°ï¼ˆ`vmess://`ã€`vless://`ã€`trojan://`ã€`ss://`ï¼‰
   - å¦‚æœæ˜¯ï¼Œä½¿ç”¨è§£ç¢¼å¾Œçš„å…§å®¹ âœ…

3. **éè¨‚é–±å…§å®¹**
   - Base64 è§£ç¢¼å¤±æ•— â†’ ä½¿ç”¨åŸå§‹æ–‡å­— âœ…
   - è§£ç¢¼æˆåŠŸä½†ä¸åŒ…å«ä»£ç†å”è­° â†’ ä½¿ç”¨åŸå§‹æ–‡å­— âœ…
   - äºŒé€²åˆ¶æª”æ¡ˆ â†’ è§£ç¢¼å¤±æ•—ï¼Œå®‰å…¨è·³é âœ…
   - äº‚ç¢¼æˆ–å…¶ä»– URLï¼ˆå¦‚ `http://`ï¼‰â†’ ä¸åŒ¹é…å”è­°ï¼Œå®‰å…¨è·³é âœ…

### 2. `inline:` - ç›´æ¥è²¼ä¸Šå…§å®¹

**ç”¨é€”**ï¼šæœ€ç°¡å–®çš„æ–¹å¼ï¼Œç›´æ¥è²¼ä¸Šç¯€é» URI

**æ ¼å¼**ï¼š
```
inline:<è¨‚é–±å…§å®¹>
```

**ç¯„ä¾‹**ï¼š
```
inline:vless://uuid@example.com:443?sni=example.com#ç¯€é»1
trojan://password@example.com:443?sni=example.com#ç¯€é»2
```

**ä½¿ç”¨å ´æ™¯**ï¼š
- å¿«é€Ÿæ¸¬è©¦å–®å€‹æˆ–å¤šå€‹ç¯€é»
- è‡¨æ™‚æ·»åŠ ç¯€é»è€Œä¸éœ€è¦å»ºç«‹è¨‚é–± URL
- é–‹ç™¼å’Œèª¿è©¦æ™‚é©—è­‰è§£æé‚è¼¯

### 3. `data:` - Data URL æ ¼å¼

**ç”¨é€”**ï¼šæ”¯æ´æ¨™æº–çš„ [Data URL](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URLs) æ ¼å¼

**æ ¼å¼**ï¼š
```
data:text/plain,<å…§å®¹>
data:text/plain;base64,<Base64ç·¨ç¢¼å…§å®¹>
```

**ç¯„ä¾‹**ï¼š
```
# ç´”æ–‡å­—
data:text/plain,vless://uuid@example.com:443#node1

# Base64 ç·¨ç¢¼
data:text/plain;base64,dmxlc3M6Ly91dWlkQGV4YW1wbGUuY29tOjQ0MyNub2RlMQ==
```

**ä½¿ç”¨å ´æ™¯**ï¼š
- éœ€è¦ URL ç·¨ç¢¼çš„ç‰¹æ®Šå­—ç¬¦
- èˆ‡å…¶ä»–å·¥å…·æˆ–è…³æœ¬æ•´åˆï¼ˆæ¨™æº–æ ¼å¼ï¼‰
- å£“ç¸®æˆ–ç·¨ç¢¼å¤§é‡ç¯€é»æ•¸æ“š

### æ··åˆä½¿ç”¨

ä½ å¯ä»¥åŒæ™‚ä½¿ç”¨å¤šç¨®ä¾†æºé¡å‹ï¼š

```
https://example.com/subscription          # æ¨™æº–è¨‚é–±ï¼ˆä»»æ„è·¯å¾‘ï¼‰
https://example.com/sub                    # ä¸å¸¶ .txt ä¹Ÿå¯ä»¥
https://example.com/api/v2ray              # API ç«¯é»
inline:vless://uuid@test.com:443#æ¸¬è©¦     # ç›´æ¥è²¼ä¸Š
data:text/plain;base64,dmxlc3M6Ly8uLi4=   # Base64 ç·¨ç¢¼
```

**æ³¨æ„äº‹é …**ï¼š
- âš ï¸ å–®å€‹ä¾†æºå»ºè­°ä¸è¶…é 10KB
- ğŸ’¡ å°‘é‡ç¯€é»ï¼ˆ< 10 å€‹ï¼‰ï¼šä½¿ç”¨ `inline:`
- ğŸ’¡ å¤§é‡ç¯€é»ï¼šä½¿ç”¨å¤–éƒ¨ HTTP(S) URL
- ğŸ’¡ ç”Ÿç”¢ç’°å¢ƒï¼šå»ºè­°ä½¿ç”¨å¤–éƒ¨ URLï¼ˆæ›´æ˜“ç¶­è­·ï¼‰
- âœ… **URL è·¯å¾‘ä¸é™æ ¼å¼**ï¼š`/sub`ã€`/123`ã€`/abc`ã€`/api/nodes` éƒ½å¯ä»¥

## é…ç½®é¸é …

åœ¨ç®¡ç†é¢æ¿çš„ **Config** å€åŸŸå¯ä»¥è¨­å®šï¼š

### chunk_sizeï¼ˆåˆ†å¡Šå¤§å°ï¼‰
- **é è¨­å€¼**ï¼š400
- **ç¯„åœ**ï¼š50 - 2000
- **èªªæ˜**ï¼šæ¯å€‹åˆ†å¡ŠåŒ…å«çš„ç¯€é»æ•¸é‡ã€‚è¼ƒå°çš„å€¼æœƒç”¢ç”Ÿæ›´å¤šåˆ†å¡Šï¼Œä½†æ¯å€‹æª”æ¡ˆæ›´å°ã€‚

### Base64 encodeï¼ˆBase64 ç·¨ç¢¼ï¼‰
- **é è¨­å€¼**ï¼šé—œé–‰
- **èªªæ˜**ï¼š
  - **é—œé–‰**ï¼šè¨‚é–±å…§å®¹ç‚ºç´”æ–‡å­—æ ¼å¼ï¼ˆæ¯è¡Œä¸€å€‹ç¯€é» URIï¼‰
  - **é–‹å•Ÿ**ï¼šè¨‚é–±å…§å®¹æœƒè¢« Base64 ç·¨ç¢¼ï¼ˆæ¨™æº–è¨‚é–±æ ¼å¼ï¼Œç›¸å®¹å¤§éƒ¨åˆ†ä»£ç†å·¥å…·ï¼‰

**ç¯„ä¾‹ï¼š**

æœªç·¨ç¢¼ï¼ˆé—œé–‰ï¼‰ï¼š
```
vless://uuid@example.com:443?sni=example.com#ç¯€é»1
trojan://password@example.com:443?sni=example.com#ç¯€é»2
ss://method:password@example.com:443#ç¯€é»3
```

å·²ç·¨ç¢¼ï¼ˆé–‹å•Ÿï¼‰ï¼š
```
dmxlc3M6Ly91dWlkQGV4YW1wbGUuY29tOjQ0Mz9zbmk9ZXhhbXBsZS5jb20j6IqC6bueMQp0cm9qYW46Ly9wYXNzd29yZEBleGFtcGxlLmNvbTo0NDM/c25pPWV4YW1wbGUuY29tI+iKgueCuTIKc3M6Ly9tZXRob2Q6cGFzc3dvcmRAZXhhbXBsZS5jb206NDQzI+iKgueCuTM=
```

**æ³¨æ„ï¼š**
- ä¿®æ”¹è¨­å®šå¾Œï¼Œé»æ“Š **Save** å„²å­˜
- é»æ“Š **Refresh Now** ç«‹å³å¥—ç”¨æ–°è¨­å®šä¸¦æ›´æ–°è¨‚é–±å…§å®¹
- Base64 è¨­å®šè®Šæ›´æ™‚ï¼Œæ‰€æœ‰åˆ†å¡Šéƒ½æœƒå¼·åˆ¶æ›´æ–°

## æ›´æ–°æµç¨‹

1. å¾ KV è®€å–ä¾†æºæ¸…å–®èˆ‡é…ç½®ï¼ˆ`chunk_size`ã€`base64_encode`ï¼‰
2. ä½µç™¼æŠ“å–å„ä¾†æºï¼ˆæ”¯æ´ HTTP(S)ã€`inline:`ã€`data:` æ ¼å¼ï¼‰
3. è§£æè¨‚é–±å…§å®¹ï¼ˆè‡ªå‹•åµæ¸¬ Base64 ç·¨ç¢¼ï¼‰
4. æ­£è¦åŒ–ç‚ºçµ±ä¸€è¨˜éŒ„çµæ§‹
5. å»é‡ï¼ˆä¾ `server:port:servername:credential`ï¼‰
6. é‡æ–°ç·¨ç¢¼ç‚ºåŸå”è­° URI
7. åˆ†å¡Šï¼ˆä¾ `chunk_size`ï¼‰
8. Base64 ç·¨ç¢¼ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
9. è¨ˆç®—å„å¡Š ETag
10. åƒ…æ›´æ–°è®Šæ›´çš„å¡Šï¼ˆæœ€å°å¯«å…¥ï¼‰
11. æ¸…ç†å¤šé¤˜èˆŠå¡Š
12. å›å‚³çµ±è¨ˆ JSON
